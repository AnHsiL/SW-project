<!doctype html>
<html lang="en">
  <head>
    <title>車主列表</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<script src="./javascripts/showRider.js" defer></script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link rel="stylesheet" href="./stylesheets/showRider_style.css">
    <script src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
  </head>
  <body>
    <header>
      <br>
        <h2>海大共乘系統</h2>
        <div style="text-align: right;">
          <a href="chooseIdentity.html" type="button" class="btn btn-dark btn-sm">切換身分</a>
          <a href="chooseIdentity.html" type="button" class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal">登出</a>
          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">登出</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  確定要登出嗎!!!!!!
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                  <button id="btn_logout" type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button></a>
                </div>
              </div>
            </div>
          </div>
        </div>
        
    </header>
    <br>
    <div class="container">
      <!--篩選條件按鈕-->
      <a href="#" type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#selectmodal" style="align-items: center;" >篩選條件</a>
      <!--跳出視窗-->  
      <div class="modal fade" id="selectmodal" area-hidden="true">
        <div class="modal-dialog">
          	<div class="modal-content">
				<div class="modal-header">
				<h5>條件篩選</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				
				<div class="modal-body">
					<div class="form-group1">
						偏好車主性別
						<div class="form-check">
							<input class="form-check-input" type="radio" name="gender_filter" id="sexM" checked value="男性">
							<label class="form-check-label" for="sexM">男</label>
							<br>
							<input class="form-check-input" type="radio" name="gender_filter" id="sexF" value="女性">
							<label class="form-check-label" for="sexF">女</label>                   
						</div>                  
					</div>        
					<br>              
					<div class="form-group2">
						車主是否備有安全帽
						<div class="form-check">
							<input class="form-check-input" type="radio" name="helmet" id="yes" checked value="是">
							<label class="form-check-label" for="yes">有</label>
							<br>
							<input class="form-check-input" type="radio" name="helmet" id="no" value="否">
							<label class="form-check-label" for="no">無</label>                   
						</div>
					</div>                            
					<br>    
					<select class="form-select" aria-label="Default select example">
						<option selected>目的地地區</option>
						<option value="仁愛區" name="area">仁愛區</option>
						<option value="中正區" name="area">中正區</option>
						<option value="信義區" name="area">信義區</option>
						<option value="中山區" name="area">中山區</option>
						<option value="安樂區" name="area">安樂區</option>
						<option value="七堵區" name="area">七堵區</option>
						<option value="暖暖區" name="area">暖暖區</option>
					</select>          
					<div class="input-group">                  
						<span class="input-group-text" id="destination">目的地</span>
						<input type="text" class="form-control" placeholder="完整地址" aria-label="Username" aria-describedby="destination" id="d" name="destination" required="required">
					</div>      
					<select class="form-select" aria-label="Default select example">
						<option selected>乘車地區</option>
						<option value="仁愛區" name="takingPlace">仁愛區</option>
						<option value="中正區" name="takingPlace">中正區</option>
						<option value="信義區" name="takingPlace">信義區</option>
						<option value="中山區" name="takingPlace">中山區</option>
						<option value="安樂區" name="takingPlace">安樂區</option>
						<option value="七堵區" name="takingPlace">七堵區</option>
						<option value="暖暖區" name="takingPlace">暖暖區</option>
					</select>              
					<br>
					<button type="submit" class="btn btn-primary" id="btn_filter_query">確認</button>
				</div>
          	</div>
        </div>
      </div>
      
      <!--修改個人資料按鈕-->
      <a href="#" type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#infomodal">修改個人資料</a>
      <!--跳出視窗-->
      <div class="modal fade" id="infomodal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5>修改資料</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              	<div class="input-group">
					<span class="input-group-text" id="newName" style="width:112px;">姓名</span>
					<input type="text" name="name" class="form-control" placeholder="新姓名" aria-label="Username" aria-describedby="newName" id="nN">
				</div>     
				<div class="input-group">
					<span class="input-group-text" id="newPhonenumber" style="width:112px;">手機號碼</span>
					<input type="text" name="phone" class="form-control" aria-label="Username" aria-describedby="newPhonenumber" id="nP" pattern="[0-9]{10}">
				</div>              
				<div class="form-group">
					性別
					<div class="form-check">
						<input class="form-check-input" type="radio" name="gender" id="newsexM" value="男性">
						<label class="form-check-label" for="newsexM">男</label>
						<br>
						<input class="form-check-input" type="radio" name="gender" id="newsexF" value="女性">
						<label class="form-check-label" for="newsexF">女</label>                   
					</div>                  
				</div>
				<button type="submit" class="btn btn-primary" id="btn_changeBasicData">確認</button>
            </div>
          </div>
        </div>
			</div>      
			<div class="card-group">

			</div>      
		</div>
	</body>	
	<script>
		var i;
		var n ;
		var count;
		var pressedBtn;
		var name;
    // Example starter JavaScript for disabling form submissions if there are invalid fields

		$(window).ready(function () {
			swal("請先篩選");
			$('#btn_changeBasicData').click(function() {
				changeBasicData($('#nN').val(), $('#nP').val(), $('input[name=gender]:checked').val());
			});
			$('#btn_filter_query').click(function() {
				$('#selectmodal').modal('hide');
				swal("篩選中，請耐心等候");
				filter_query(
					$('input[name=gender_filter]:checked').val(), 
					$('input[name=helmet]:checked').val(), 
					$('input[name=area]:checked').val(), 
					$('#d').val(), 
					$('input[name=takingPlace]:checked').val()
				);
			});
			
		});
		
		function changeBasicData(name, phone, gender){
			$.ajax({
				url: '/changePassengerInfo',
				type: 'post',
				data: {name : name, phone: phone, gender:gender},
				success: function(chkRes){
					if(chkRes.result == "change succ"){
						swal("修改成功!","","success");
						$('#infomodal').modal('hide');
					}
					else{
						swal("change data error.", "", "error");
					}
				},
				error: function(){
					swal("帳號已被登出，請重新登入", "", "error");
					location.href="/SignIn.html";
				}
			})
		}

		function filter_query(gender, helmet, area, destination, takingPlace){
			$.ajax({
				url: '/riderFilter',
				type: 'post',
				data: {
					gender		:gender		,
					helmet		:helmet		,
					area		:area		,
					destination	:destination,
					takingPlace	:takingPlace
				},
				success: function(chkRes){
					if(chkRes.status == "match 成功"){
						filter();
					}
					else{
						alert("filter error.");
					}
				},
				error: function(){
					swal("帳號已被登出，請重新登入", "", "error");
					location.href="/SignIn.html";
				}
			})
		}

		function sendAndSet_query(takingTime, takingPlace, remark){
			$.ajax({
				url: '/changePassengerInfo',
				type: 'post',
				data: {
					takingTime	:takingTime	,
					takingPlace	:takingPlace,
					remark		:remark
				},
				success: function(chkRes){
			
				},
				error: function(){
					alert("帳號已被登出，請重新登入");
					location.href="/SignIn.html";
				}
			})
		}

		function selectAnswer(){
			var s = $("[name='Sex']:checked").val();
			var h = $("[name='Helmet']:checked").val();
			var d = document.getElementById("d").value;
			var g = document.getElementById("g").value;
			alert(d);
			alert(g);
			//var z = $('select').val();
		}
		function sendRequest(c){
			pressedBtn = c;
			if(document.getElementById('t'+c).value.length==0 || document.getElementById('gO'+c).value.length==0)alert("請填寫上車時間和地點");
			else{
				//alert(document.getElementById("t"+c).value);
				$('#sendmodal'+c).modal('hide');
				sendAndSet_query(	
					document.getElementById("t"+c).value,
					document.getElementById("gO"+c).value,
					document.getElementById("oth"+c).value				
				);
				$.ajax({
					url : 'http://127.0.0.1:3000/getRiderFilter',
					type : 'GET',
					success:function(data){
						name = JSON.stringify(data.result[c]);
						//alert(name);  
						post(name);       
					}       
				})
				for(var j = 0; j <= count - 1; j++){
					document.getElementById(j).disabled = true;
				}  
				window.setTimeout(setDisabled, 208000);
			}
			
		}
		/*function sendRequest(c){
			pressedBtn = c;
			for(var j = 0; j <= count - 1; j++){
			  document.getElementById(j).disabled = true;
			}     
			$.ajax({
				url : 'http://127.0.0.1:3000/getRiderFilter',
				type : 'GET',
				success:function(data){
					name = JSON.stringify(data.result[c]);
					//alert(name);  
					post(name);       
				}       
			})
		}*/
		function post(n){
			fetch('http://127.0.0.1:3000/sendOrderToOwner', {
			body: n, // must match 'Content-Type' header
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached         
			headers: {
				'content-type': 'application/json'
			},
			method: 'POST', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors'
			})
			.then(response => console.log(n))
			.then(response => response.json()) 
			.catch(function() {
				console.log(n);
			});
		}
    //顯示篩選內容
    function filter(){
      $('.card-group').empty();       
      $.ajax({
			url : '/getRiderFilter',
			type : 'GET',
			success: function(data){
        	count = data.result.length;
			console.log(data);
			var rate;
        count = data.result.length;
        if(count==0)swal("無結果，請更改篩選條件");
		    for(var i = 0; i < data.result.length; i++){
				if(data.result[i].rateCount==0)rate="無";
				else rate=data.result[i].rateTotal/data.result[i].rateCount;
			$('.card-group').append(   
				'<div class="col-md-12">'+
            		'<div class="card border-primary">'+
              			'<div class="row g-0">'+
							'<div class="col-md-4" style="text-align:center;">'+
							'<img src="'+data.result[i].picture+'" class="img-fluid rounded-start" alt="還沒有照片">'+
							'</div>'+
                '<div class="col-md-8">'+
					'<div class="card-header" style="background-color: rgb(157, 215, 233)">'+
					data.result[i].name+
					'</div>'+
					'<div class="card-body" style="background-color: rgb(205, 238, 248)">'+
					'性別: '+ data.result[i].gender+
					'<br>'+
					'可搭乘時間: '+ data.result[i].workingTime+
					'<br>'+
					'可接送地點: '+ data.result[i].area+
					'<br>'+
					'聯絡方式: '+ data.result[i].phone+
					'<br>'+
					'是否備有安全帽: '+ data.result[i].helmet+
					'</div>'+
                '<div class="card-footer" style="background-color: rgb(157, 215, 233)">'+
                  '<div style="text-align: center;">'+
                    '評分: '+rate+'<br>'+
                    '<button id="'+i+'" name="sendButton" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#sendmodal'+i+'" style="background-color: rgb(0, 0, 0); text-align: center;">發送請求</button>'+
                    '<!--發送請求彈出視窗-->'+
                    '<div class="modal fade" id="sendmodal'+i+'">'+
                      '<div class="modal-dialog">'+
                        '<div class="modal-content">'+
                          '<div class="modal-header">'+
                            '<h1 class="modal-title fs-5" id="exampleModalLabel">希望乘車資訊</h1>'+
                            '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>'+
                          '</div>'+
                          '<div class="modal-body">'+
                            '<div id="current_date">'+year+'/'+month+'/'+day+'</p>'+
							'<iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>'+
							//'<form action="http://127.0.0.1:3000/changePassengerInfo" method="post" target="dummyframe" id="newModalForm">'+ 
                              '<div class="input-group">'+
                                '<span class="input-group-text" id="time">今天</span>'+
                                '<input type="text" name="takingTime" class="form-control is-valid" placeholder="24小時制" aria-describedby="time" pattern="([0-1]{1}[0-9]{1}|20|21|22|23):[0-5]{1}[0-9]{1}" id="t'+i+'" required>'+
                              '</div>'+
                              '<div class="input-group">'+
                                '<span class="input-group-text" id="getOn">地點</span>'+
                                '<input type="text" name="takingPlace" class="form-control is-valid" placeholder="上車地點" aria-describedby="getOn" id="gO'+i+'" required>'+
                              '</div>'+
                              '<div class="input-group">'+
                                '<span class="input-group-text" id="other">備註</span>'+
                                '<input type="text" name="remark" class="form-control" placeholder="" aria-describedby="other" id="oth'+i+'">'+
                              '</div>'+
                              '<br>'+
                              '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>'+
                              '<button onclick="sendRequest('+i+');" id="closeSBtn" class="btn btn-primary">確認發送</button>'+
							//'</form>'+
                          '</div>'+
                        '</div>'+
						'<div class="card-header" style="background-color: rgb(157, 215, 233)">'+
							data.result[i].name+
						'</div>'+
						'<div class="card-body" style="background-color: rgb(205, 238, 248)">'+
							'性別: '+ data.result[i].gender+
							'<br>'+
							'可搭乘時間: '+ data.result[i].workingTime+
							'<br>'+
							'可接送地點: '+ data.result[i].area+
							'<br>'+
							'聯絡方式: '+ data.result[i].phone+
							'<br>'+
							'是否備有安全帽: '+ data.result[i].helmet+
						'</div>'
                       
          )
        }
			},
      error:function(){
        swal("no", "", "error");
      }
		})         
    }
	
		function setDisabled() {
			for(var k = 0; k <= count - 1; k++){
			  document.getElementById(k).disabled = false;
			}
		}
		function setstr(s) {
			document.getElementById(pressedBtn).innerHTML=s; 
			s -= 1;
			if(s >= 0){
				setTimeout(setstr,1000,s);
			}
			else{document.getElementById(pressedBtn).innerHTML='發送請求';}
		}
    date = new Date();
    year = date.getFullYear();
    var month = date.getMonth()+1 ;
    day = date.getDate();
	</script>
</html>